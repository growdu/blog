# 多地多中心方案调研

## 达梦

达梦的两地三中心是一个完整的分布式集群，中心间通过raft协议进行数据同步。

而且达梦的两地三中心内的所有节点就是一个raft group。

其架构如下：

![alt text](image.png)

一般是5节点集群，生产2个节点，同城两个节点，异地一个节点，组成一个大的raft集群。

### 关键技术

1. 并行线程管理
2. 计算与存储分离
3. RAFT归档
4. 动态增删节点
5. 分布式事务一致性
6. 自动选举主库
7. 自动故障处理
8.  多副本影子库
9. 指定副本参与日志提交

### 网络要求

#### 同城

容灾网络距离：< 100km ，裸光纤连接。
传输延迟：< 1ms （单向）。
网络真实带宽：大于业务的峰值写 IO 带宽。

#### 异地

容灾网络距离：无限制。
传输延迟：< 50ms （单向）。
网络真实带宽：大于业务的平均写 IO 带宽。

### 硬件资源

1. cpu：最低16核
2. 内存： 最低64g
3. 磁盘： 最低1024g
4. 网卡： 最低千兆，建议万兆

### RTO

1. 中心内RPO=0，RTO<30s;
2. 同城RPO=0，RTO<60;
3. RPO<1分钟，RTO<10分钟；

## opengauss

opengauss两地三中心架构分成两种：

- 两地三中心（分布式集群）
- 两地三中心流复制容灾（主备集群，异地中心级联复制）

opengauss两地三中心架构如下：

![alt text](image-2.png)

实际节点结构如下：

![alt text](image-3.png)

其功能如下：

- 灾备数据库实例升主允许丢失一定的数据，RPO<=10秒 ；灾备数据库实例处于normal态，灾备升主RTO<=10分钟，数据库实例处于degraded状态等叠加故障场景下，执行灾备数据库实例升主RTO一般在20分钟以内。

- 演练特性：计划内主备数据库实例倒换，无数据丢失RPO=0，RTO<=20分钟(包含主数据库实例降为灾备实例，灾备数据库实例升主两个流程)。

## oceanbase


### 三地五中心五副本

oecanbase典型的方案就是三地五中心五副本。5个副本是一个分布式的大集群。

其方案架构如下：

![alt text](image-1.png)

该架构特点如下：

- 三个城市，组成一个 5 副本的集群。
- 任何一个 IDC 或者城市的故障，依然构成多数派，可以确保 RPO=0。
- 由于 3 份以上副本才能构成多数派，但每个城市最多只有 2 份副本，为降低时延，城市 1 和城市 2 应该离得较近，以降低同步 Redo-Log 的时延。
- 为降低成本，城市 3 可以只部署日志型副本（只有日志）。

其RPO、RTO能力如下：

- RPO： 同城切换不丢数据，如果采用三地部署，可以做到异地切换不丢数据
- RTO： 不管是同城还是异地，只要是不丢数据的切换，都可以做到一分钟内完成。丢数据的切换也可以在数分钟之内完成。
- 多活：把不同Partition的leader分到不同的机房，可以实现双活或多活。
- 运维: 数据同步是数据库内置的功能，不依赖于数据库之外的设施，运维方便。

## 总结

两地三中心和多地多中心主要是根据金融行业的监管要求来制定，商业银行数据中心监管指引明确规定了商业银行数据中心的要求。

> 第七条 总资产规模一千亿元人民币以上且跨省设立分支机构的法人商业银行，及省级农村信用联合社应设立异地模式灾备中心，重要信息系统灾难恢复能力应达到《信息安全技术信息系统灾难恢复规范》中定义的灾难恢复等级第5级（含）以上；其他法人商业银行应设立同城模式灾备中心并实现数据异地备份，重要信息系统灾难恢复能力应达到《信息安全技术信息系统灾难恢复规范》中定义的灾难恢复等级第4级（含）以上。

最高等级为6级，监管里最高要求四级：

- 第四级不要求有远程备份，也不要求实时备份。(RPO数小时到一天，RTO数小时到两天)
- 第五级要求有远程备份和实时备份。(RPO小于30分钟，RTO数分钟到两天)
- 第六级要求数据零丢失，灾难自动切换(RPO = 0, RTO数分钟)

可以看到对于多地多中心方案来说，主要是以下几个方面：

1. 对于异地中心或者除了同城灾备中心之外，仅仅要求可以部署就行，不要求自动切换（不要求RTO和RPO为0）；
2. 对于RPO和RTO来说，应该优先保证RPO=0，而对于RTO来说，则可以在几分钟内；
3. 对于异地中心来说，不要求同步，也不要求自动切换；

而从opengauss和oceanbase的相关方案文档和介绍中来看，除了本身架构实现上本身属于分布式集群，并未着重强调跨中心的自动切换，尤其是自动切换到异地中心。自动切换一般仅要求切换到同城灾备中心。

# reference

1. https://eco.dameng.com/community/article/d756b06e7475a96b444518b34c5f7483
2. https://www.oceanbase.com/docs/enterprise-oceanbase-database-cn-10000000000354617
3. https://docs.opengauss.org/zh/docs/3.1.0/docs/Description/%E4%BC%81%E4%B8%9A%E7%BA%A7%E5%A2%9E%E5%BC%BA%E7%89%B9%E6%80%A7.html
4. https://open.oceanbase.com/blog/10900385