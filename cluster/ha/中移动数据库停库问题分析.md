# 中移动数据库停库问题分析

## 问题描述

同城双中心，主中心数据库停库，且未触发中心间切换。

## 问题分析

### 主中心停库原因

#### 主库停库分析

查看主库68的kbha.log，可以看到主库在2023-06-03 05:19:20失去了多数派。

![](./img/primary_without_quorate.png)

少数派持续了一分多钟后，在2023-06-03 05:20:03重新进入多数派,这中间相差**43秒**。

![](./img/primary_to_quorate.png)

在这个过程中，数据库因为处于少数派超时导致数据库停库,可以看到从少数派到停库经过的时间为**21秒**。

![](./img/primary_stop.png)

根据repmgr.conf中的配置，

```shell
reconnect_attempts=5
reconnect_interval=6
```

则数据库处于少数派的时间超过**5*6-10=20秒时**，就会停止数据库。

#### 备库停库原因分析

查看备库78的kbha.log，与主库类似，在2023-06-03 05:19:32从多数派变为少数派，与**主库相差12秒。**

![](./img/standby_without_quorate.png)

少数派持续了一分多钟后，在2023-06-03 05:20:03重新进入多数派,这中间相差**31秒**。可以看到备库与主库在同一时间重新进入多数派。

![](./img/standby_to_quorate.png)

与主库一样，在这个过程中，数据库因为处于少数派超时导致数据库停库,可以看到从少数派到停库经过的时间为**21秒**。

![](./img/standby_stop.png)

<font color="red">综上所述，主中心数据库停库的原因为corosync进入少数派超时。即corosync由于网络波动等因素导致进入少数派后，未在预期的20秒内恢复。</font>

#### corosync进入少数派原因分析

经过上层应用日志分析，停库原因为corosync进入少数派，分析corosync日志。主库68上的corosync从05:19:20.764开始有节点离开并进入少数派，在05:20:03.692恢复，与上层应用时间相符。

![](./img/primary_corosync.png)

但后续又出现token超时，且在恢复过程中，token出现多次超时，直到恢复。

![](./img/primary_token_timeout.png)

![](./img/primary_token_timeout_more.png)

<font color="red">综上所述，在06-03 05:19到06-03 05:42这段时间内，网络出现波动，导致corosync在这个过程中进入少数派。</font>

### 备中心未切换原因

查看备中心伪主库hamgr.log日志，分析如下：

生产中心因为少数派导致kbha无法提供服务，observer在生产中心恢复之前无法连接到kbha，但在触发observer跨中心切换时，生产中心corosync恢复多数派，kbha正常提供服务，observer查询到节点信息，未触发中心间切换。

observer在2023-06-03 05:17:01时无法查询节点信息，在2023-06-03 05:41:01时恢复，这中间间隔时间为24秒。

![](./img/observer_failed.png)

![](./img/observer_ok.png)

<font color="red">observer未触发跨中心切换是因为生产中心的kbha服务在切换时间之前恢复。</font>

## 问题结论

<font color="red">1.网络波动导致corosync进入少数派，其恢复时间超过了数据库停库允许的少数派时间，导致数据库停库。</font>

<font color="red">2.生产中心corosync的故障恢复时间小于observer的跨中心切换时间，导致未进行跨中心切换。</font>

## 问题解决

1. corosync主要受网络波动影响，需要增加网络监控以确认网络波动情况，尝试调整网络参数使corosync恢复时间变短（网络波动的情况下）；
2. observer未触发跨中心切换的原因为observer在corosync能连接成功的情况下，仅根据corosync是否能连接来判断是否切换，考虑增加尝试连接数据库的逻辑，若数据库均连接不上，是否触发跨中心切换。